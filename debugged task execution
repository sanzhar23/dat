using System;
using System.Collections.Concurrent;
using System.Threading;
using System.Threading.Tasks;

public sealed class TaskExecutor
{
    private readonly ConcurrentQueue<Func<Task>> _queue = new();
    private readonly SemaphoreSlim _semaphore;

    public TaskExecutor(int maxConcurrency)
    {
        _semaphore = new SemaphoreSlim(maxConcurrency);
    }

    public void Enqueue(Func<Task> task)
    {
        _queue.Enqueue(task);
        _ = ExecuteAsync();
    }

    private async Task ExecuteAsync()
    {
        if (!_queue.TryDequeue(out var task))
            return;

        await _semaphore.WaitAsync();

        try
        {
            await task();
        }
        finally
        {
            _semaphore.Release();
        }
    }
}
